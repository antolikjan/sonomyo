---
import Layout from '../../../../layouts/Layout.astro'
import Hero from '../../../../components/blocks/hero/PageHeader.astro'
import BlogPosts from '../../../../components/blocks/blog/BlogPosts.astro'
import { getCollection } from 'astro:content'

const langs = ['cs', 'en'] as const

export async function getStaticPaths() {
  const allPosts = await getCollection('blog', ({ data }) => !data.draft)

  return langs.flatMap((lang) => {
    const postsInLang = allPosts.filter((p) => p.id.startsWith(`${lang}/blog/`))
    const uniqueTags = [...new Set(postsInLang.flatMap((p) => p.data.tags ?? []))]

    return uniqueTags.map((tag) => {
      const filteredPosts = postsInLang.filter((p) => (p.data.tags ?? []).includes(tag))
      return { params: { lang, tag }, props: { posts: filteredPosts, tag } }
    })
  })
}

const { tag } = Astro.params
const { posts } = Astro.props

const SEO = {
  title: `Sonomyo | posts tagged as ${tag}`,
  description: `Posts tagged as ${tag}.`,
}

const header = {
  title: `Posts about <br><strong>${tag}</strong>`,
  text: `Browse posts in this topic.`,
}

const lang = Astro.params.lang === 'en' ? 'en' : 'cs'
---

<Layout title={SEO.title} description={SEO.description}>
  <Hero title={header.title} text={header.text} />
  <BlogPosts data={posts} lang={lang}/>
</Layout>
