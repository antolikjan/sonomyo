---
import Layout from '../../../../layouts/Layout.astro'
import Hero from '../../../../components/blocks/hero/PageHeader.astro'
import BlogPosts from '../../../../components/blocks/blog/BlogPosts.astro'
import { getCollection } from 'astro:content'

export async function getStaticPaths() {

  const langs = ['cs', 'en'] as const

  const allPosts = await getCollection('blog', ({ data }) => !data.draft)

  // union of tags across BOTH languages
  const allTags = [...new Set(allPosts.flatMap((p) => p.data.tags ?? []))]

  return langs.flatMap((lang) =>
    allTags.map((tag) => {
      const postsInLang = allPosts.filter(
        (p) => p.id.startsWith(`${lang}/blog/`) && (p.data.tags ?? []).includes(tag)
      )

      return {
        params: { lang, tag: encodeURIComponent(tag) },
        props: { posts: postsInLang, tag }, // tag here is the display tag
      }
    })
  )
}

const lang = Astro.params.lang === 'en' ? 'en' : 'cs'
const tagFromUrl = decodeURIComponent(Astro.params.tag)
const { posts } = Astro.props

const header = {
  title: `Posts about <br><strong>${tagFromUrl}</strong>`,
  text: posts.length ? '' : 'No posts for this tag in this language (yet).',
}
---
<Layout title={`Sonomyo | ${tagFromUrl}`}>
  <Hero title={header.title} text={header.text} />

  {posts.length ? (
    <BlogPosts data={posts} lang={lang} />
  ) : (
    <div class="mx-auto max-w-3xl px-6 pb-12">
      <a class="text-primary-700 underline" href={`/${lang}/blog`}>Back to blog</a>
    </div>
  )}
</Layout>
1